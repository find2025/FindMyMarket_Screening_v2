<!-- 
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  FindMyMarket â€” HubSpot LP Footer HTML v3
  
  ì‹¤ì œ í¼ êµ¬ì¡° ê¸°ë°˜ (HubSpot ì‹ í˜• Form Editor / hsfc- í´ë˜ìŠ¤)
  
  ê°ì§€ í•„ë“œ:
    - industry_category (radio) â€” ì¹´í…Œê³ ë¦¬ ì„ íƒ
    - interview_product (multi checkbox) â€” êµ¬ì²´ì  ì œí’ˆ/ì„œë¹„ìŠ¤ ì„ íƒ
    - product_image (file) â€” ì œí’ˆ ì‚¬ì§„
    - receipt_image (file) â€” ì˜ìˆ˜ì¦
  
  ì‚½ì…: HubSpot Landing Page â†’ Settings â†’ Advanced â†’ Footer HTML
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->

<style>
/* â•â•â• FindMyMarket Screening v3 â•â•â• */
:root {
  --fm-blue: #2563eb; --fm-blue-lt: #eff6ff; --fm-blue-bd: #93c5fd;
  --fm-green: #059669; --fm-green-lt: #ecfdf5;
  --fm-red: #dc2626; --fm-red-lt: #fef2f2;
  --fm-amber: #d97706; --fm-amber-lt: #fffbeb;
  --fm-g50: #f9fafb; --fm-g100: #f3f4f6; --fm-g200: #e5e7eb;
  --fm-g300: #d1d5db; --fm-g500: #6b7280; --fm-g700: #374151; --fm-g900: #111827;
  --fm-r: 12px;
}

/* â”€â”€ Validation banner (ì œí’ˆëª… ì…ë ¥ í›„ í‘œì‹œ) â”€â”€ */
.fm-ready-banner {
  margin: 16px 0; padding: 14px 16px;
  background: var(--fm-blue-lt); border: 1px solid var(--fm-blue-bd);
  border-radius: var(--fm-r);
  animation: fmFade 0.35s ease;
}
@keyframes fmFade {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}
.fm-ready-hd {
  display: flex; align-items: center; gap: 8px;
  font-size: 14px; font-weight: 800; color: var(--fm-g900);
}
.fm-ready-num {
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--fm-blue); color: #fff;
  font-size: 10px; font-weight: 900;
  display: flex; align-items: center; justify-content: center;
}
.fm-ready-desc {
  font-size: 12px; color: var(--fm-g500); margin: 4px 0 0 30px;
}
.fm-product-tag {
  display: inline-block; background: var(--fm-blue); color: #fff;
  font-size: 12px; font-weight: 700; padding: 3px 12px;
  border-radius: 16px; margin: 8px 0 0 30px;
}

/* â”€â”€ Custom dropzone (ê¸°ì¡´ file input ëŒ€ì²´) â”€â”€ */
.fm-dz-wrap {
  margin: 10px 0;
  animation: fmFade 0.3s ease;
}
.fm-dropzone {
  border: 2px dashed var(--fm-g300);
  border-radius: var(--fm-r);
  padding: 22px 14px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--fm-g50);
}
.fm-dropzone:hover {
  border-color: var(--fm-blue-bd);
  background: #f8fbff;
}
.fm-dropzone.fm-over {
  border-color: var(--fm-blue);
  background: var(--fm-blue-lt);
  box-shadow: 0 0 0 4px rgba(37,99,235,0.08);
}
.fm-dropzone.fm-full {
  opacity: 0.4;
  pointer-events: none;
}
.fm-dz-icon { font-size: 26px; margin-bottom: 3px; }
.fm-dz-title { font-size: 13px; font-weight: 700; color: var(--fm-g700); }
.fm-dz-link { color: var(--fm-blue); text-decoration: underline; }
.fm-dz-sub { font-size: 10px; color: var(--fm-g500); margin-top: 2px; }
.fm-dz-fmts { display: flex; gap: 4px; justify-content: center; margin-top: 7px; }
.fm-fmt { background: var(--fm-g100); color: var(--fm-g500); font-size: 9px; font-weight: 700; padding: 2px 5px; border-radius: 3px; text-transform: uppercase; }

/* â”€â”€ File list â”€â”€ */
.fm-file-item {
  display: flex; align-items: center; gap: 9px;
  padding: 7px 10px; background: #fff;
  border: 1px solid var(--fm-g200); border-radius: 8px;
  margin-top: 7px; animation: fmFade 0.25s ease;
}
.fm-file-thumb { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; flex-shrink: 0; }
.fm-file-ph { width: 40px; height: 40px; border-radius: 6px; background: var(--fm-g100); display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0; }
.fm-file-name { font-size: 12px; font-weight: 600; color: var(--fm-g700); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.fm-file-meta { font-size: 10px; color: var(--fm-g500); }
.fm-file-rm {
  width: 22px; height: 22px; border-radius: 50%; border: none;
  background: transparent; color: var(--fm-g500); font-size: 12px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.fm-file-rm:hover { background: var(--fm-red-lt); color: var(--fm-red); }
.fm-file-cnt { font-size: 10px; color: var(--fm-g500); text-align: right; margin-top: 3px; }

/* â”€â”€ Validation result â”€â”€ */
.fm-vp { margin-top: 10px; border-radius: var(--fm-r); overflow: hidden; animation: fmFade 0.35s ease; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
.fm-vp-hd { display: flex; align-items: center; gap: 10px; padding: 11px 14px; font-size: 13px; font-weight: 700; }
.fm-vp-bd { padding: 0 14px 12px; font-size: 12px; line-height: 1.7; }
.fm-vp-bd dt { font-weight: 700; color: var(--fm-g700); margin-top: 4px; }
.fm-vp-bd dd { margin: 0; color: var(--fm-g500); }
.fm-vp.pass { border: 1px solid #86efac; }
.fm-vp.pass .fm-vp-hd { background: var(--fm-green-lt); color: var(--fm-green); }
.fm-vp.warn { border: 1px solid #fde68a; }
.fm-vp.warn .fm-vp-hd { background: var(--fm-amber-lt); color: var(--fm-amber); }
.fm-vp.fail { border: 1px solid #fca5a5; }
.fm-vp.fail .fm-vp-hd { background: var(--fm-red-lt); color: var(--fm-red); }

.fm-ring { width: 38px; height: 38px; flex-shrink: 0; position: relative; }
.fm-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
.fm-ring .bg { fill: none; stroke: #e5e7eb; stroke-width: 4; }
.fm-ring .fg { fill: none; stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }
.fm-ring-v { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; }

.fm-loading {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 14px; background: var(--fm-blue-lt);
  border: 1px solid var(--fm-blue-bd); border-radius: var(--fm-r);
  margin-top: 10px; animation: fmFade 0.3s ease;
}
.fm-spin {
  width: 18px; height: 18px;
  border: 3px solid var(--fm-blue-bd); border-top-color: var(--fm-blue);
  border-radius: 50%; animation: fmSpin 0.7s linear infinite; flex-shrink: 0;
}
@keyframes fmSpin { to { transform: rotate(360deg); } }

/* Banners */
.fm-banner-pass {
  margin-top: 14px; padding: 14px;
  background: linear-gradient(135deg, #064e3b, #0f172a);
  border-radius: var(--fm-r); color: #fff; text-align: center;
  animation: fmFade 0.4s ease;
}
.fm-banner-pass h4 { font-size: 14px; font-weight: 900; margin-bottom: 3px; }
.fm-banner-pass p { font-size: 11px; color: #94a3b8; }
.fm-banner-fail {
  margin-top: 14px; padding: 14px;
  background: var(--fm-red-lt); border: 1px solid #fca5a5;
  border-radius: var(--fm-r); text-align: center;
}
.fm-banner-fail h4 { font-size: 13px; font-weight: 700; color: var(--fm-red); margin-bottom: 3px; }
.fm-banner-fail p { font-size: 11px; color: var(--fm-g500); }
.fm-banner-review {
  margin-top: 14px; padding: 12px 14px;
  background: var(--fm-amber-lt); border: 1px solid #fde68a;
  border-radius: var(--fm-r); display: flex; align-items: center; gap: 9px;
}
</style>

<script>
(function() {
  'use strict';

  // ================================================================
  //  â˜… CONFIG â€” ë°°í¬ ì „ ìˆ˜ì • â˜…
  // ================================================================
  var CONFIG = {
    // Vercel API ì—”ë“œí¬ì¸íŠ¸
    API_ENDPOINT: "https://find-my-market-screening-v2.vercel.app/api/validate-image",

    // â”€â”€ ì‹¤ì œ HubSpot í¼ í•„ë“œ name (0-1/ ì ‘ë‘ì‚¬ í¬í•¨) â”€â”€
    CATEGORY_FIELD:  "0-1/industry_category",       // radio í•„ë“œ
    PRODUCT_FIELD:   "0-1/interview_product",         // multi checkbox í•„ë“œ
    PRODUCT_IMAGE:   "0-1/product_image",             // file í•„ë“œ
    RECEIPT_IMAGE:   "0-1/receipt_image",              // file í•„ë“œ
    EMAIL_FIELD:     "0-1/email",                     // email í•„ë“œ

    // ë“œë˜ê·¸ì•¤ë“œë¡­ ì„¤ì •
    UPLOADS: {
      product_image: {
        fieldName: "0-1/product_image",
        label: "ì œí’ˆ/ì‹œìˆ  ì‚¬ì§„",
        icon: "ğŸ“¸",
        role: "product",
        maxFiles: 3,
        maxSizeMB: 10,
        formats: ["JPG", "PNG", "WEBP", "HEIC"],
      },
      receipt_image: {
        fieldName: "0-1/receipt_image",
        label: "ì˜ìˆ˜ì¦ / êµ¬ë§¤ ì¦ë¹™",
        icon: "ğŸ§¾",
        role: "receipt",
        maxFiles: 2,
        maxSizeMB: 10,
        formats: ["JPG", "PNG", "PDF"],
      },
    },
  };

  // ================================================================
  //  STATE
  // ================================================================
  var S = {
    category: null,       // radio ì„ íƒê°’ (health_supplements ë“±)
    categoryLabel: "",    // ë¼ë²¨ í…ìŠ¤íŠ¸
    productName: "",      // ì²´í¬ëœ ì œí’ˆ ë¼ë²¨ (ì‰¼í‘œ êµ¬ë¶„)
    productValues: [],    // ì²´í¬ëœ ì œí’ˆ value ë°°ì—´
    files: { product_image: [], receipt_image: [] },
    results: {},
    form: null,
    injected: false,
  };

  // ================================================================
  //  í¼ ë¡œë“œ ê°ì§€ (ì‹ í˜• í¼ â€” hsfc-Form)
  // ================================================================
  function tryBoot() {
    var form = document.querySelector('.hsfc-Form');
    if (form && !form.dataset.fmV3) {
      form.dataset.fmV3 = '1';
      S.form = form;
      console.log('[FM] v3 boot â€” ì‹ í˜• í¼ ê°ì§€ë¨');
      init();
      return true;
    }
    return false;
  }

  // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ê°ì§€ ì‹œë„
  if (document.readyState === 'complete') {
    tryBoot();
  }
  document.addEventListener('DOMContentLoaded', function() {
    if (!tryBoot()) {
      var n = 0;
      var poll = setInterval(function() {
        if (tryBoot() || ++n > 40) clearInterval(poll);
      }, 500);
    }
  });
  // HubSpot ë©”ì‹œì§€ ì´ë²¤íŠ¸ë„ ê°ì§€
  window.addEventListener('message', function(e) {
    if (e.data && e.data.type === 'hsFormCallback') {
      setTimeout(tryBoot, 800);
    }
  });
  // ìµœì¢… fallback
  window.addEventListener('load', function() {
    setTimeout(tryBoot, 1500);
  });

  // ================================================================
  //  ì´ˆê¸°í™”
  // ================================================================
  function init() {
    watchCategory();
    watchProductName();
    setupDropzones();
    console.log('[FM] ì´ˆê¸°í™” ì™„ë£Œ â€” í•„ë“œ ê°ì§€ ì¤‘');
  }

  // ================================================================
  //  1. industry_category (radio) ê°ì§€
  // ================================================================
  function watchCategory() {
    var radios = S.form.querySelectorAll('input[name="' + CONFIG.CATEGORY_FIELD + '"]');
    console.log('[FM] ì¹´í…Œê³ ë¦¬ radio ë°œê²¬:', radios.length + 'ê°œ');

    radios.forEach(function(radio) {
      radio.addEventListener('change', function() {
        if (radio.checked) {
          S.category = radio.value;
          // ë¼ë²¨ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
          var label = radio.closest('label');
          S.categoryLabel = label ? label.textContent.trim() : radio.value;
          console.log('[FM] ì¹´í…Œê³ ë¦¬ ì„ íƒ:', S.category, 'â†’', S.categoryLabel);
          onSelectionUpdated();
        }
      });
      // ì´ë¯¸ ì„ íƒëœ ê²½ìš°
      if (radio.checked) {
        S.category = radio.value;
        var label = radio.closest('label');
        S.categoryLabel = label ? label.textContent.trim() : radio.value;
      }
    });
  }

  // ================================================================
  //  2. interview_product (multi checkbox) ê°ì§€
  // ================================================================
  function watchProductName() {
    var checkboxes = S.form.querySelectorAll('input[name="' + CONFIG.PRODUCT_FIELD + '"]');
    if (checkboxes.length === 0) {
      console.warn('[FM] ì œí’ˆ ì²´í¬ë°•ìŠ¤ ì—†ìŒ:', CONFIG.PRODUCT_FIELD);
      return;
    }
    console.log('[FM] ì œí’ˆ ì²´í¬ë°•ìŠ¤ ë°œê²¬:', checkboxes.length + 'ê°œ');

    checkboxes.forEach(function(cb) {
      cb.addEventListener('change', function() {
        readCheckedProducts();
        onSelectionUpdated();
      });
      // ì´ë¯¸ ì²´í¬ëœ ê²½ìš°
      if (cb.checked) {
        readCheckedProducts();
      }
    });
  }

  function readCheckedProducts() {
    var checked = S.form.querySelectorAll('input[name="' + CONFIG.PRODUCT_FIELD + '"]:checked');
    var values = [];
    var labels = [];
    checked.forEach(function(cb) {
      values.push(cb.value);
      var label = cb.closest('label');
      labels.push(label ? label.textContent.trim() : cb.value);
    });
    S.productName = labels.join(', ');
    S.productValues = values;
    console.log('[FM] ì„ íƒ ì œí’ˆ:', S.productName, '(' + values.join(', ') + ')');
  }

  // ================================================================
  //  3. ì„ íƒ/ì…ë ¥ ì—…ë°ì´íŠ¸ â†’ ì—…ë¡œë“œ ì˜ì—­ í‘œì‹œ
  // ================================================================
  function onSelectionUpdated() {
    // ì¹´í…Œê³ ë¦¬ + ì œí’ˆëª… ë‘˜ ë‹¤ ìˆì–´ì•¼ ê²€ì¦ ê°€ëŠ¥
    var ready = S.category && S.productName;

    // ë°°ë„ˆ í‘œì‹œ
    showReadyBanner(ready);

    // ê¸°ì¡´ ê²°ê³¼ ì´ˆê¸°í™” í›„ ì¬ê²€ì¦
    if (ready) {
      S.results = {};
      Object.keys(CONFIG.UPLOADS).forEach(function(key) {
        var vp = document.getElementById('fm-val-' + key);
        if (vp) vp.innerHTML = '';
      });
      var ob = document.getElementById('fm-overall');
      if (ob) ob.innerHTML = '';

      // ì´ë¯¸ íŒŒì¼ì´ ìˆìœ¼ë©´ ì¬ê²€ì¦
      Object.keys(CONFIG.UPLOADS).forEach(function(key) {
        var cfg = CONFIG.UPLOADS[key];
        if (S.files[key].length > 0 && S.files[key][0].base64) {
          runValidation(key, S.files[key][0], cfg);
        }
      });
    }
  }

  function showReadyBanner(ready) {
    var existing = document.getElementById('fm-ready-banner');
    if (existing) existing.remove();

    if (!ready) return;

    var banner = document.createElement('div');
    banner.id = 'fm-ready-banner';
    banner.className = 'fm-ready-banner';
    banner.innerHTML =
      '<div class="fm-ready-hd">' +
        '<div class="fm-ready-num">âœ“</div>' +
        '<div>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ AIê°€ ìë™ ê²€ì¦í•©ë‹ˆë‹¤</div>' +
      '</div>' +
      '<div class="fm-ready-desc">ì•„ë˜ íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ì— ì œí’ˆ ì‚¬ì§„ê³¼ ì˜ìˆ˜ì¦ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</div>' +
      '<div class="fm-product-tag">' + S.categoryLabel + ' Â· ' + S.productName + '</div>';

    // ì œí’ˆ ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ ë‹¤ìŒì— ì‚½ì…
    var productCb = S.form.querySelector('input[name="' + CONFIG.PRODUCT_FIELD + '"]');
    var fieldGroup = productCb ? productCb.closest('[data-hsfc-id]') : null;
    if (fieldGroup) {
      fieldGroup.parentElement.insertBefore(banner, fieldGroup.nextSibling);
    }
  }

  // ================================================================
  //  4. ë“œë˜ê·¸ì•¤ë“œë¡­ ì£¼ì… (ê¸°ì¡´ file input ì˜†ì—)
  // ================================================================
  function setupDropzones() {
    Object.keys(CONFIG.UPLOADS).forEach(function(key) {
      var cfg = CONFIG.UPLOADS[key];
      var nativeInput = S.form.querySelector('input[name="' + cfg.fieldName + '"]');
      if (!nativeInput) {
        console.warn('[FM] íŒŒì¼ í•„ë“œ ì—†ìŒ:', cfg.fieldName);
        return;
      }
      console.log('[FM] íŒŒì¼ í•„ë“œ ë°œê²¬:', cfg.fieldName);

      // ê¸°ì¡´ file inputì˜ ë¶€ëª¨ ì˜ì—­ ì°¾ê¸°
      var fieldGroup = nativeInput.closest('[data-hsfc-id]');

      // ë“œë˜ê·¸ì•¤ë“œë¡­ UI ìƒì„±
      var wrap = document.createElement('div');
      wrap.className = 'fm-dz-wrap';
      wrap.id = 'fm-dz-wrap-' + key;
      wrap.innerHTML =
        '<div class="fm-dropzone" id="fm-dz-' + key + '">' +
          '<div class="fm-dz-icon">' + cfg.icon + '</div>' +
          '<div class="fm-dz-title">íŒŒì¼ì„ ëŒì–´ë†“ê±°ë‚˜ <span class="fm-dz-link">í´ë¦­í•˜ì—¬ ì„ íƒ</span></div>' +
          '<div class="fm-dz-sub">ìµœëŒ€ ' + cfg.maxFiles + 'ê°œ Â· ' + cfg.maxSizeMB + 'MB ì´í•˜</div>' +
          '<div class="fm-dz-fmts">' + cfg.formats.map(function(f) { return '<span class="fm-fmt">' + f + '</span>'; }).join('') + '</div>' +
          '<input type="file" accept="image/*" multiple style="display:none">' +
        '</div>' +
        '<div id="fm-list-' + key + '"></div>' +
        '<div class="fm-file-cnt" id="fm-cnt-' + key + '"></div>' +
        '<div id="fm-val-' + key + '"></div>';

      // fieldGroup ë°”ë¡œ ë’¤ì— ì‚½ì…
      if (fieldGroup) {
        fieldGroup.parentElement.insertBefore(wrap, fieldGroup.nextSibling);
      }

      // ì´ë²¤íŠ¸ ì—°ê²°
      initDz(key, cfg);
    });

    // ì¢…í•© ê²°ê³¼ ì˜ì—­ ì‚½ì…
    var overall = document.createElement('div');
    overall.id = 'fm-overall';
    // submit ë²„íŠ¼ ì•ì— ì‚½ì…
    var submitBtn = S.form.querySelector('button[type="submit"], input[type="submit"], [data-hsfc-id="SubmitButton"]');
    if (submitBtn) {
      var submitParent = submitBtn.closest('[data-hsfc-id]') || submitBtn.parentElement;
      submitParent.parentElement.insertBefore(overall, submitParent);
    } else {
      S.form.appendChild(overall);
    }
  }

  function initDz(key, cfg) {
    var dz = document.getElementById('fm-dz-' + key);
    if (!dz) return;
    var fi = dz.querySelector('input[type="file"]');

    dz.addEventListener('click', function(e) {
      if (!e.target.closest('.fm-file-rm')) fi.click();
    });
    fi.addEventListener('change', function() {
      addFiles(key, Array.from(fi.files), cfg);
      fi.value = '';
    });
    dz.addEventListener('dragenter', function(e) { e.preventDefault(); dz.classList.add('fm-over'); });
    dz.addEventListener('dragover', function(e) { e.preventDefault(); dz.classList.add('fm-over'); });
    dz.addEventListener('dragleave', function() { dz.classList.remove('fm-over'); });
    dz.addEventListener('drop', function(e) {
      e.preventDefault(); dz.classList.remove('fm-over');
      addFiles(key, Array.from(e.dataTransfer.files), cfg);
    });
  }

  // ================================================================
  //  5. íŒŒì¼ ê´€ë¦¬
  // ================================================================
  function addFiles(key, newFiles, cfg) {
    var store = S.files[key];
    for (var i = 0; i < newFiles.length; i++) {
      var file = newFiles[i];
      if (store.length >= cfg.maxFiles) break;
      if (file.size > cfg.maxSizeMB * 1024 * 1024) continue;
      if (store.some(function(f) { return f.file.name === file.name; })) continue;

      var entry = { id: Date.now() + Math.random(), file: file, preview: null, base64: null };

      if (file.type.startsWith('image/')) {
        (function(ent) {
          var reader = new FileReader();
          reader.onload = function(e) {
            ent.preview = e.target.result;
            ent.base64 = e.target.result.split(',')[1];
            renderList(key, cfg);
            // ì¹´í…Œê³ ë¦¬ + ì œí’ˆëª…ì´ ìˆìœ¼ë©´ ìë™ ê²€ì¦
            if (S.category && S.productName) {
              runValidation(key, ent, cfg);
            }
          };
          reader.readAsDataURL(ent.file);
        })(entry);
      }
      store.push(entry);
    }
    renderList(key, cfg);
  }

  function removeFile(key, fileId) {
    S.files[key] = S.files[key].filter(function(f) { return f.id !== fileId; });
    var cfg = CONFIG.UPLOADS[key];
    renderList(key, cfg);
    var vp = document.getElementById('fm-val-' + key);
    if (vp) vp.innerHTML = '';
    delete S.results[key];
    var ob = document.getElementById('fm-overall');
    if (ob) ob.innerHTML = '';
    updateDz(key, cfg);
  }
  window._fmRm = removeFile;

  function renderList(key, cfg) {
    var el = document.getElementById('fm-list-' + key);
    var cnt = document.getElementById('fm-cnt-' + key);
    var store = S.files[key];
    if (el) {
      el.innerHTML = store.map(function(e) {
        var th = e.preview
          ? '<img class="fm-file-thumb" src="' + e.preview + '">'
          : '<div class="fm-file-ph">ğŸ–¼ï¸</div>';
        var sz = e.file.size < 1048576
          ? (e.file.size / 1024).toFixed(1) + ' KB'
          : (e.file.size / 1048576).toFixed(1) + ' MB';
        return '<div class="fm-file-item">' + th +
          '<div style="flex:1;min-width:0"><div class="fm-file-name">' + e.file.name + '</div>' +
          '<div class="fm-file-meta">' + sz + '</div></div>' +
          '<button class="fm-file-rm" onclick="event.stopPropagation();window._fmRm(\'' + key + '\',' + e.id + ')">âœ•</button></div>';
      }).join('');
    }
    if (cnt) cnt.textContent = store.length > 0 ? store.length + ' / ' + cfg.maxFiles + 'ê°œ' : '';
    updateDz(key, cfg);
  }

  function updateDz(key, cfg) {
    var dz = document.getElementById('fm-dz-' + key);
    if (!dz) return;
    if (S.files[key].length >= cfg.maxFiles) {
      dz.classList.add('fm-full');
    } else {
      dz.classList.remove('fm-full');
    }
  }

  // ================================================================
  //  6. Claude Vision ê²€ì¦
  // ================================================================
  function runValidation(key, entry, cfg) {
    if (!entry.base64 || !S.productName || !S.category) return;

    var vp = document.getElementById('fm-val-' + key);
    if (!vp) return;

    // ê²€ì¦ ëŒ€ìƒ ì´ë¦„: ì¹´í…Œê³ ë¦¬ + êµ¬ì²´ì  ì œí’ˆëª…
    var validationTarget = S.categoryLabel + ' â€” ' + S.productName;

    vp.innerHTML =
      '<div class="fm-loading">' +
        '<div class="fm-spin"></div>' +
        '<div>' +
          '<div style="font-size:12px;font-weight:700;color:var(--fm-blue)">AIê°€ ì´ë¯¸ì§€ë¥¼ ê²€ì¦ ì¤‘...</div>' +
          '<div style="font-size:10px;color:var(--fm-g500);margin-top:1px">"<strong>' + validationTarget + '</strong>"ê³¼(ì™€)ì˜ ê´€ë ¨ì„± í™•ì¸ ì¤‘</div>' +
        '</div>' +
      '</div>';

    fetch(CONFIG.API_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        image_base64: entry.base64,
        image_type: entry.file.type || 'image/jpeg',
        image_role: cfg.role,
        product_name: validationTarget,
        contact_email: getFormVal(CONFIG.EMAIL_FIELD),
      }),
    })
    .then(function(res) {
      if (!res.ok) throw new Error('API ' + res.status);
      return res.json();
    })
    .then(function(result) {
      S.results[key] = result;
      renderResult(key, result);
      checkOverall();
    })
    .catch(function(err) {
      console.error('[FM] ê²€ì¦ ì˜¤ë¥˜:', err);
      vp.innerHTML =
        '<div class="fm-loading" style="border-color:#fde68a;background:var(--fm-amber-lt)">' +
          '<div style="font-size:18px">âš ï¸</div>' +
          '<div><div style="font-size:12px;font-weight:700;color:var(--fm-amber)">ê²€ì¦ ì¤‘ ì˜¤ë¥˜</div>' +
          '<div style="font-size:10px;color:var(--fm-g500)">í¼ ì œì¶œì€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div></div>' +
        '</div>';
      S.results[key] = { recommendation: 'review', relevance_score: 0, reasoning: 'API ì˜¤ë¥˜' };
      checkOverall();
    });
  }

  function renderResult(key, r) {
    var vp = document.getElementById('fm-val-' + key);
    if (!vp) return;

    var s = r.relevance_score || 0;
    var rec = r.recommendation || 'review';
    var C = 2 * Math.PI * 17;
    var off = C * (1 - s);

    var cls, icon, txt, col;
    if (rec === 'approve') { cls = 'pass'; icon = 'âœ…'; txt = 'ê²€ì¦ í†µê³¼'; col = 'var(--fm-green)'; }
    else if (rec === 'review') { cls = 'warn'; icon = 'âš ï¸'; txt = 'ì¶”ê°€ ê²€í† '; col = 'var(--fm-amber)'; }
    else { cls = 'fail'; icon = 'âŒ'; txt = 'ë¯¸í†µê³¼'; col = 'var(--fm-red)'; }

    var flags = (r.red_flags && r.red_flags.length > 0)
      ? '<dt>ğŸš© ì˜ì‹¬</dt><dd>' + r.red_flags.join(', ') + '</dd>' : '';

    vp.innerHTML =
      '<div class="fm-vp ' + cls + '">' +
        '<div class="fm-vp-hd">' +
          '<div class="fm-ring">' +
            '<svg viewBox="0 0 38 38"><circle class="bg" cx="19" cy="19" r="17"/>' +
            '<circle class="fg" cx="19" cy="19" r="17" style="stroke:' + col + ';stroke-dasharray:' + C + ';stroke-dashoffset:' + off + '"/></svg>' +
            '<div class="fm-ring-v" style="color:' + col + '">' + Math.round(s * 100) + '</div>' +
          '</div>' +
          '<div><div>' + icon + ' ' + txt + '</div>' +
          '<div style="font-size:10px;font-weight:400;color:var(--fm-g500)">ì ìˆ˜: ' + s.toFixed(2) + '</div></div>' +
        '</div>' +
        '<div class="fm-vp-bd"><dl>' +
          (r.product_or_procedure ? '<dt>ì‹ë³„ ì œí’ˆ/ì‹œìˆ </dt><dd>' + r.product_or_procedure + '</dd>' : '') +
          (r.brand_or_clinic ? '<dt>ë¸Œëœë“œ/ê¸°ê´€</dt><dd>' + r.brand_or_clinic + '</dd>' : '') +
          (r.date_detected ? '<dt>ë‚ ì§œ</dt><dd>' + r.date_detected + '</dd>' : '') +
          (r.amount_detected ? '<dt>ê¸ˆì•¡</dt><dd>' + r.amount_detected + '</dd>' : '') +
          '<dt>AI íŒë‹¨</dt><dd>' + (r.reasoning || 'â€”') + '</dd>' +
          flags +
        '</dl></div>' +
      '</div>';
  }

  // ================================================================
  //  7. ì¢…í•© ê²°ê³¼
  // ================================================================
  function checkOverall() {
    var el = document.getElementById('fm-overall');
    if (!el) return;

    var keys = Object.keys(CONFIG.UPLOADS);
    var allDone = keys.every(function(k) { return S.results[k]; });
    if (!allDone) { el.innerHTML = ''; return; }

    var results = keys.map(function(k) { return S.results[k]; });
    var hasReject = results.some(function(r) { return r.recommendation === 'reject'; });
    var hasReview = results.some(function(r) { return r.recommendation === 'review'; });
    var overall = hasReject ? 'reject' : hasReview ? 'review' : 'approve';

    if (overall === 'approve') {
      el.innerHTML = '<div class="fm-banner-pass"><h4>ğŸ‰ ê²€ì¦ ì™„ë£Œ!</h4><p>"' + S.productName + '" ê´€ë ¨ ì´ë¯¸ì§€ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p></div>';
    } else if (overall === 'reject') {
      el.innerHTML = '<div class="fm-banner-fail"><h4>ì´ë¯¸ì§€ê°€ "' + S.productName + '"ê³¼(ì™€) ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</h4><p>ì˜¬ë°”ë¥¸ ì‚¬ì§„/ì˜ìˆ˜ì¦ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p></div>';
    } else {
      el.innerHTML =
        '<div class="fm-banner-review">' +
          '<div style="font-size:16px">ğŸ“‹</div>' +
          '<div><div style="font-size:12px;font-weight:700;color:var(--fm-amber)">ì¶”ê°€ ê²€í†  í•„ìš”</div>' +
          '<div style="font-size:10px;color:var(--fm-g500)">ì œì¶œ ê°€ëŠ¥. ë‹´ë‹¹ì í™•ì¸ í›„ ì—°ë½ë“œë¦½ë‹ˆë‹¤.</div></div>' +
        '</div>';
    }
  }

  // ================================================================
  //  ìœ í‹¸
  // ================================================================
  function getFormVal(name) {
    if (!S.form) return '';
    var input = S.form.querySelector('input[name="' + name + '"]');
    return input ? input.value : '';
  }

})();
</script>
