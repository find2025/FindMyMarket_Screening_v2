<!-- 
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  FindMyMarket â€” HubSpot LP Footer HTML
  ì¸í„°ë·° ìŠ¤í¬ë¦¬ë‹ í¼ (ë“œë˜ê·¸ì•¤ë“œë¡­ ì—…ë¡œë“œ + Claude Vision ê²€ì¦)
  
  ì‚½ì… ìœ„ì¹˜: HubSpot Landing Page â†’ Settings â†’ Advanced â†’ Footer HTML
  ì „ì œ ì¡°ê±´:
    1. HubSpot Formì— ë‹¤ìŒ Contact Property í•„ë“œê°€ ìˆì–´ì•¼ í•¨:
       - interview_category (Dropdown / Radio)
       - product_image (File)
       - receipt_image (File)
       - screening_status (Single-line text)
       - screening_score (Number)
    2. Vercelì— validate-image API ë°°í¬ ì™„ë£Œ
    3. Landing Pageì— Form ëª¨ë“ˆì´ ë°°ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•¨
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->

<!-- â‘  CSS -->
<style>
/* â”€â”€ FindMyMarket Custom Form Styles â”€â”€ */
:root {
  --fmm-blue: #2563eb;
  --fmm-blue-light: #eff6ff;
  --fmm-blue-border: #93c5fd;
  --fmm-green: #059669;
  --fmm-green-light: #ecfdf5;
  --fmm-red: #dc2626;
  --fmm-red-light: #fef2f2;
  --fmm-amber: #d97706;
  --fmm-amber-light: #fffbeb;
  --fmm-gray-50: #f9fafb;
  --fmm-gray-100: #f3f4f6;
  --fmm-gray-200: #e5e7eb;
  --fmm-gray-300: #d1d5db;
  --fmm-gray-500: #6b7280;
  --fmm-gray-700: #374151;
  --fmm-gray-900: #111827;
  --fmm-radius: 12px;
  --fmm-shadow: 0 1px 6px rgba(0,0,0,0.06);
}

@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');

/* â”€â”€ Category Image Cards â”€â”€ */
.fmm-category-grid {
  display: grid !important;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  list-style: none !important;
  padding: 0 !important;
  margin: 10px 0 0 0 !important;
}
@media (max-width: 480px) {
  .fmm-category-grid { grid-template-columns: repeat(2, 1fr) !important; }
}
.fmm-category-grid li {
  margin: 0 !important;
  padding: 0 !important;
  list-style: none !important;
}
.fmm-card-label {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 16px 10px 14px !important;
  border: 2px solid var(--fmm-gray-200) !important;
  border-radius: var(--fmm-radius) !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
  background: #fff !important;
  text-align: center !important;
  position: relative !important;
  min-height: 120px !important;
  user-select: none !important;
}
.fmm-card-label:hover {
  border-color: var(--fmm-blue-border) !important;
  box-shadow: 0 2px 10px rgba(37,99,235,0.08) !important;
}
.fmm-card-label.fmm-selected {
  border-color: var(--fmm-blue) !important;
  background: var(--fmm-blue-light) !important;
  box-shadow: 0 0 0 3px rgba(37,99,235,0.12) !important;
}
.fmm-card-label input { position: absolute !important; opacity: 0 !important; width: 0 !important; height: 0 !important; }
.fmm-card-img {
  width: 56px; height: 56px;
  object-fit: contain;
  margin-bottom: 8px;
  border-radius: 8px;
}
.fmm-card-emoji {
  font-size: 36px;
  margin-bottom: 8px;
  line-height: 1;
}
.fmm-card-text {
  font-size: 13px !important;
  font-weight: 700 !important;
  color: var(--fmm-gray-700) !important;
  line-height: 1.3 !important;
}
.fmm-card-sub {
  font-size: 10px;
  color: var(--fmm-gray-500);
  margin-top: 2px;
}
.fmm-card-check {
  position: absolute;
  top: 7px; right: 7px;
  width: 20px; height: 20px;
  border-radius: 50%;
  border: 2px solid var(--fmm-gray-300);
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  color: transparent;
  transition: all 0.15s;
}
.fmm-card-label.fmm-selected .fmm-card-check {
  border-color: var(--fmm-blue);
  background: var(--fmm-blue);
  color: #fff;
}

/* â”€â”€ Dropzone â”€â”€ */
.fmm-dropzone-wrap { margin-top: 6px; }
.fmm-dz-desc {
  font-size: 12px;
  color: var(--fmm-gray-500);
  margin-bottom: 10px;
}
.fmm-dropzone {
  border: 2px dashed var(--fmm-gray-300);
  border-radius: var(--fmm-radius);
  padding: 28px 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.25s;
  background: var(--fmm-gray-50);
  position: relative;
}
.fmm-dropzone:hover {
  border-color: var(--fmm-blue-border);
  background: #f0f7ff;
}
.fmm-dropzone.fmm-dragover {
  border-color: var(--fmm-blue);
  background: var(--fmm-blue-light);
  box-shadow: 0 0 0 4px rgba(37,99,235,0.1);
}
.fmm-dropzone.fmm-has-error {
  border-color: #fca5a5;
  background: var(--fmm-red-light);
}
.fmm-dz-icon { font-size: 32px; margin-bottom: 6px; }
.fmm-dz-title { font-size: 14px; font-weight: 700; color: var(--fmm-gray-700); }
.fmm-dz-link { color: var(--fmm-blue); text-decoration: underline; }
.fmm-dz-sub { font-size: 11px; color: var(--fmm-gray-500); margin-top: 2px; }
.fmm-dz-formats { display: flex; gap: 5px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
.fmm-fmt-tag {
  background: var(--fmm-gray-100);
  color: var(--fmm-gray-500);
  font-size: 10px; font-weight: 600;
  padding: 2px 7px; border-radius: 4px;
  text-transform: uppercase;
}
.fmm-dropzone input[type="file"] { display: none; }

/* â”€â”€ File list â”€â”€ */
.fmm-file-list { margin-top: 10px; }
.fmm-file-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 12px;
  background: var(--fmm-gray-50);
  border: 1px solid var(--fmm-gray-200);
  border-radius: 8px;
  margin-top: 8px;
  animation: fmmSlideUp 0.25s ease;
  position: relative;
}
@keyframes fmmSlideUp {
  from { opacity:0; transform: translateY(6px); }
  to   { opacity:1; transform: translateY(0); }
}
.fmm-file-thumb {
  width: 44px; height: 44px;
  border-radius: 6px; object-fit: cover;
  flex-shrink: 0;
}
.fmm-file-placeholder {
  width: 44px; height: 44px;
  border-radius: 6px;
  background: var(--fmm-gray-100);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
}
.fmm-file-info { flex: 1; min-width: 0; }
.fmm-file-name {
  font-size: 13px; font-weight: 600; color: var(--fmm-gray-700);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.fmm-file-meta { font-size: 11px; color: var(--fmm-gray-500); margin-top: 1px; }
.fmm-file-remove {
  width: 26px; height: 26px; border-radius: 50%;
  border: none; background: transparent;
  color: var(--fmm-gray-500); font-size: 14px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: all 0.15s;
}
.fmm-file-remove:hover { background: var(--fmm-red-light); color: var(--fmm-red); }
.fmm-file-count { margin-top: 6px; font-size: 11px; color: var(--fmm-gray-500); text-align: right; }
.fmm-error-msg { font-size: 12px; color: var(--fmm-red); margin-top: 6px; display: none; }
.fmm-error-msg.show { display: block; }

/* â”€â”€ Validation Result â”€â”€ */
.fmm-validation-panel {
  margin-top: 16px;
  border-radius: var(--fmm-radius);
  overflow: hidden;
  animation: fmmSlideUp 0.35s ease;
  box-shadow: var(--fmm-shadow);
}
.fmm-vp-header {
  display: flex; align-items: center; gap: 12px;
  padding: 16px 18px;
  font-size: 14px; font-weight: 700;
}
.fmm-vp-body { padding: 0 18px 18px; font-size: 13px; line-height: 1.7; }
.fmm-vp-body dt { font-weight: 700; color: var(--fmm-gray-700); margin-top: 8px; }
.fmm-vp-body dd { margin: 0 0 0 0; color: var(--fmm-gray-500); }

.fmm-vp-approve { border: 1px solid #6ee7b7; }
.fmm-vp-approve .fmm-vp-header { background: var(--fmm-green-light); color: var(--fmm-green); }
.fmm-vp-review { border: 1px solid #fde68a; }
.fmm-vp-review .fmm-vp-header { background: var(--fmm-amber-light); color: var(--fmm-amber); }
.fmm-vp-reject { border: 1px solid #fca5a5; }
.fmm-vp-reject .fmm-vp-header { background: var(--fmm-red-light); color: var(--fmm-red); }

/* â”€â”€ Score Ring â”€â”€ */
.fmm-score-ring {
  width: 48px; height: 48px; flex-shrink: 0;
  position: relative;
}
.fmm-score-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
.fmm-score-ring .ring-bg { fill: none; stroke: #e5e7eb; stroke-width: 4; }
.fmm-score-ring .ring-fg { fill: none; stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }
.fmm-score-value {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 900;
}

/* â”€â”€ Validating Spinner â”€â”€ */
.fmm-validating {
  display: flex; align-items: center; gap: 12px;
  padding: 16px 18px;
  background: var(--fmm-blue-light);
  border: 1px solid var(--fmm-blue-border);
  border-radius: var(--fmm-radius);
  margin-top: 16px;
  animation: fmmSlideUp 0.3s ease;
}
.fmm-spinner {
  width: 24px; height: 24px;
  border: 3px solid var(--fmm-blue-border);
  border-top-color: var(--fmm-blue);
  border-radius: 50%;
  animation: fmmSpin 0.8s linear infinite;
  flex-shrink: 0;
}
@keyframes fmmSpin { to { transform: rotate(360deg); } }
.fmm-validating-text { font-size: 13px; font-weight: 600; color: var(--fmm-blue); }

/* â”€â”€ Next Step Banner â”€â”€ */
.fmm-next-step {
  margin-top: 20px;
  padding: 20px;
  background: linear-gradient(135deg, #1e3a5f, #0f172a);
  border-radius: var(--fmm-radius);
  color: #fff;
  text-align: center;
  animation: fmmSlideUp 0.4s ease;
}
.fmm-next-step h3 { font-size: 16px; font-weight: 900; margin-bottom: 6px; }
.fmm-next-step p { font-size: 13px; color: #94a3b8; }

.fmm-rejected-banner {
  margin-top: 20px;
  padding: 20px;
  background: var(--fmm-red-light);
  border: 1px solid #fca5a5;
  border-radius: var(--fmm-radius);
  text-align: center;
  animation: fmmSlideUp 0.4s ease;
}
.fmm-rejected-banner h3 { font-size: 15px; font-weight: 700; color: var(--fmm-red); margin-bottom: 4px; }
.fmm-rejected-banner p { font-size: 13px; color: var(--fmm-gray-500); }

/* â”€â”€ Section divider â”€â”€ */
.fmm-section-divider {
  height: 1px;
  background: var(--fmm-gray-100);
  margin: 24px 0;
}
</style>

<!-- â‘¡ JavaScript -->
<script>
(function() {
  'use strict';

  // ================================================================
  //  â˜… CONFIG â€” ë°°í¬ ì „ ë°˜ë“œì‹œ ìˆ˜ì •í•˜ì„¸ìš” â˜…
  // ================================================================

  const FMM_CONFIG = {
    // Vercel API ì—”ë“œí¬ì¸íŠ¸ (validate-image.js ë°°í¬ í›„ URL)
    API_ENDPOINT: "https://find-my-market-screening-v2.vercel.app/api/validate-image",

    // ì¹´í…Œê³ ë¦¬ ì˜µì…˜ (HubSpot property option value â†’ ì„¤ì •)
    CATEGORIES: {
      "botox_filler": {
        label_ko: "ë³´í†¡ìŠ¤/í•„ëŸ¬",
        label_en: "Botox/Filler",
        icon: "ğŸ’‰",         // ì´ë¯¸ì§€ URLë¡œ êµì²´ ê°€ëŠ¥: "https://cdn.../botox.png"
        useImage: false,    // trueë©´ iconì„ <img src>ë¡œ ì‚¬ìš©
      },
      "laser_treatment": {
        label_ko: "ë ˆì´ì € ì‹œìˆ ",
        label_en: "Laser Treatment",
        icon: "âœ¨",
        useImage: false,
      },
      "supplements": {
        label_ko: "ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ",
        label_en: "Supplements",
        icon: "ğŸ’Š",
        useImage: false,
      },
      "cosmetics": {
        label_ko: "í™”ì¥í’ˆ",
        label_en: "Cosmetics",
        icon: "ğŸ§´",
        useImage: false,
      },
      "dental": {
        label_ko: "ì¹˜ê³¼ ì‹œìˆ ",
        label_en: "Dental",
        icon: "ğŸ¦·",
        useImage: false,
      },
      "eye_surgery": {
        label_ko: "ë¼ì‹/ë¼ì„¹",
        label_en: "LASIK/LASEK",
        icon: "ğŸ‘ï¸",
        useImage: false,
      },
    },

    // ì—…ë¡œë“œ í•„ë“œ ì„¤ì •
    UPLOAD_FIELDS: {
      "product_image": {
        label: "ì œí’ˆ/ì‹œìˆ  ì‚¬ì§„ ì—…ë¡œë“œ",
        desc: "êµ¬ë§¤ ì œí’ˆ ì‚¬ì§„ ë˜ëŠ” ì‹œìˆ  ê´€ë ¨ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”",
        icon: "ğŸ“¸",
        maxFiles: 3,
        maxSizeMB: 10,
        accept: "image/*",
        formats: ["JPG", "PNG", "WEBP", "HEIC"],
        validate: true,     // Claude Vision ê²€ì¦ ì‹¤í–‰ ì—¬ë¶€
      },
      "receipt_image": {
        label: "ì˜ìˆ˜ì¦/êµ¬ë§¤ ì¦ë¹™",
        desc: "ì˜ìˆ˜ì¦, ì¹´ë“œ ê²°ì œ ë‚´ì—­, ì˜¨ë¼ì¸ ì£¼ë¬¸ ë‚´ì—­ ìº¡ì²˜",
        icon: "ğŸ§¾",
        maxFiles: 2,
        maxSizeMB: 10,
        accept: "image/*,.pdf",
        formats: ["JPG", "PNG", "PDF"],
        validate: true,
      },
    },

    // ì¹´í…Œê³ ë¦¬ í•„ë“œì˜ HubSpot property internal name
    CATEGORY_FIELD: "interview_category",

    // ê·¸ë¦¬ë“œ ì—´ ìˆ˜
    CATEGORY_COLUMNS: 3,
  };


  // ================================================================
  //  STATE
  // ================================================================

  const _state = {
    selectedCategory: null,
    files: {},              // fieldName â†’ [{ id, file, preview, status }]
    validationResults: {},  // fieldName â†’ result object
    formEl: null,
  };

  Object.keys(FMM_CONFIG.UPLOAD_FIELDS).forEach(k => { _state.files[k] = []; });


  // ================================================================
  //  í¼ ë¡œë“œ ê°ì§€ (Landing Pageìš©)
  // ================================================================

  window.addEventListener('message', function(event) {
    if (event.data.type === 'hsFormCallback' && event.data.eventName === 'onFormReady') {
      setTimeout(function() {
        const form = document.querySelector('.hs-form');
        if (form && !form.dataset.fmmInjected) {
          form.dataset.fmmInjected = 'true';
          _state.formEl = form;
          initFMM(form);
        }
      }, 600);
    }
  });

  // Fallback: DOMContentLoaded í›„ í´ë§
  document.addEventListener('DOMContentLoaded', function() {
    let attempts = 0;
    const poll = setInterval(function() {
      const form = document.querySelector('.hs-form');
      if (form && !form.dataset.fmmInjected) {
        form.dataset.fmmInjected = 'true';
        _state.formEl = form;
        initFMM(form);
        clearInterval(poll);
      }
      if (++attempts > 20) clearInterval(poll);
    }, 500);
  });


  // ================================================================
  //  ì´ˆê¸°í™”
  // ================================================================

  function initFMM(form) {
    console.log('[FMM] Initializing FindMyMarket form enhancement...');
    injectCategoryCards(form);
    injectDropzones(form);
    interceptFormSubmit(form);
    console.log('[FMM] Initialization complete.');
  }


  // ================================================================
  //  1. ì¹´í…Œê³ ë¦¬ ì´ë¯¸ì§€ ì¹´ë“œ ì£¼ì…
  // ================================================================

  function injectCategoryCards(form) {
    const fieldName = FMM_CONFIG.CATEGORY_FIELD;
    const container = form.querySelector(`.hs_${fieldName}`);
    if (!container) {
      console.warn(`[FMM] Category field .hs_${fieldName} not found`);
      return;
    }

    const inputs = container.querySelectorAll('input[type="radio"], select');
    if (inputs.length === 0) {
      console.warn('[FMM] No radio/select inputs found for category');
      return;
    }

    // select (ë“œë¡­ë‹¤ìš´) â†’ ì¹´ë“œë¡œ êµì²´
    const selectEl = container.querySelector('select');
    if (selectEl) {
      _convertSelectToCards(container, selectEl);
      return;
    }

    // radio â†’ ì¹´ë“œë¡œ ë³€í™˜
    const list = container.querySelector('ul.inputs-list');
    if (list) {
      _convertRadioToCards(list, container);
    }
  }

  function _convertSelectToCards(container, selectEl) {
    // ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
    const inputWrap = selectEl.closest('.input') || selectEl.parentElement;
    if (inputWrap) inputWrap.style.display = 'none';

    // ì¹´ë“œ ê·¸ë¦¬ë“œ ìƒì„±
    const grid = document.createElement('div');
    grid.className = 'fmm-category-grid';
    grid.style.gridTemplateColumns = `repeat(${FMM_CONFIG.CATEGORY_COLUMNS}, 1fr)`;

    const options = selectEl.querySelectorAll('option');
    options.forEach(opt => {
      if (!opt.value) return;  // placeholder ìŠ¤í‚µ
      const catConfig = FMM_CONFIG.CATEGORIES[opt.value];
      if (!catConfig) return;

      const card = document.createElement('div');
      card.innerHTML = `
        <label class="fmm-card-label" data-value="${opt.value}">
          <input type="hidden">
          ${catConfig.useImage
            ? `<img class="fmm-card-img" src="${catConfig.icon}" alt="${catConfig.label_ko}">`
            : `<div class="fmm-card-emoji">${catConfig.icon}</div>`}
          <span class="fmm-card-text">${catConfig.label_ko}</span>
          <span class="fmm-card-sub">${catConfig.label_en}</span>
          <div class="fmm-card-check">âœ“</div>
        </label>
      `;
      const label = card.querySelector('.fmm-card-label');
      label.addEventListener('click', () => {
        // ëª¨ë“  ì¹´ë“œ ì„ íƒ í•´ì œ
        grid.querySelectorAll('.fmm-card-label').forEach(l => l.classList.remove('fmm-selected'));
        // ì´ ì¹´ë“œ ì„ íƒ
        label.classList.add('fmm-selected');
        // select ê°’ ë³€ê²½
        selectEl.value = opt.value;
        selectEl.dispatchEvent(new Event('change', { bubbles: true }));
        _state.selectedCategory = opt.value;
        // ê¸°ì¡´ ê²€ì¦ ê²°ê³¼ ì´ˆê¸°í™”
        _clearAllValidations();
      });
      grid.appendChild(card);
    });

    container.appendChild(grid);
  }

  function _convertRadioToCards(list, container) {
    list.classList.add('fmm-category-grid');
    list.style.gridTemplateColumns = `repeat(${FMM_CONFIG.CATEGORY_COLUMNS}, 1fr)`;

    const inputs = list.querySelectorAll('input[type="radio"]');
    inputs.forEach(input => {
      const catConfig = FMM_CONFIG.CATEGORIES[input.value];
      if (!catConfig) return;

      const li = input.closest('li');
      const label = input.closest('label') || (li ? li.querySelector('label') : null);
      if (!label || li.dataset.fmmDone) return;
      li.dataset.fmmDone = 'true';

      // ì¹´ë“œ ìŠ¤íƒ€ì¼ë¡œ ë³€í™˜
      label.className = 'fmm-card-label';
      input.style.cssText = 'position:absolute;opacity:0;width:0;height:0';

      const textSpan = label.querySelector('span');
      const origText = textSpan ? textSpan.textContent : input.value;

      label.innerHTML = `
        ${input.outerHTML}
        ${catConfig.useImage
          ? `<img class="fmm-card-img" src="${catConfig.icon}" alt="${catConfig.label_ko}">`
          : `<div class="fmm-card-emoji">${catConfig.icon}</div>`}
        <span class="fmm-card-text">${catConfig.label_ko}</span>
        <span class="fmm-card-sub">${catConfig.label_en}</span>
        <div class="fmm-card-check">âœ“</div>
      `;

      const newInput = label.querySelector('input');
      newInput.addEventListener('change', () => {
        list.querySelectorAll('.fmm-card-label').forEach(l => l.classList.remove('fmm-selected'));
        if (newInput.checked) {
          label.classList.add('fmm-selected');
          _state.selectedCategory = newInput.value;
          _clearAllValidations();
        }
      });
    });
  }


  // ================================================================
  //  2. ë“œë˜ê·¸ì•¤ë“œë¡­ ì—…ë¡œë“œ ì£¼ì…
  // ================================================================

  function injectDropzones(form) {
    Object.entries(FMM_CONFIG.UPLOAD_FIELDS).forEach(([fieldName, config]) => {
      const container = form.querySelector(`.hs_${fieldName}`);
      if (!container) {
        console.warn(`[FMM] Upload field .hs_${fieldName} not found`);
        return;
      }

      // ê¸°ì¡´ input ìˆ¨ê¸°ê¸°
      const nativeInput = container.querySelector('input[type="file"]');
      if (nativeInput) nativeInput.closest('.input').style.display = 'none';

      // ë“œë˜ê·¸ì•¤ë“œë¡­ UI ìƒì„±
      const wrap = document.createElement('div');
      wrap.className = 'fmm-dropzone-wrap';
      wrap.innerHTML = `
        <div class="fmm-dz-desc">${config.desc}</div>
        <div class="fmm-dropzone" id="fmm-dz-${fieldName}">
          <div class="fmm-dz-icon">${config.icon}</div>
          <div class="fmm-dz-title">íŒŒì¼ì„ ëŒì–´ë†“ê±°ë‚˜ <span class="fmm-dz-link">í´ë¦­í•˜ì—¬ ì„ íƒ</span></div>
          <div class="fmm-dz-sub">ìµœëŒ€ ${config.maxFiles}ê°œ Â· íŒŒì¼ë‹¹ ${config.maxSizeMB}MB ì´í•˜</div>
          <div class="fmm-dz-formats">
            ${config.formats.map(f => `<span class="fmm-fmt-tag">${f}</span>`).join('')}
          </div>
          <input type="file" accept="${config.accept}" multiple>
        </div>
        <div class="fmm-file-list" id="fmm-list-${fieldName}"></div>
        <div class="fmm-error-msg" id="fmm-err-${fieldName}"></div>
        <div class="fmm-file-count" id="fmm-count-${fieldName}"></div>
        <div id="fmm-validation-${fieldName}"></div>
      `;

      container.appendChild(wrap);
      _initDropzone(fieldName, config);
    });
  }

  function _initDropzone(fieldName, config) {
    const dz = document.getElementById(`fmm-dz-${fieldName}`);
    if (!dz) return;
    const fileInput = dz.querySelector('input[type="file"]');

    dz.addEventListener('click', (e) => {
      if (e.target.closest('.fmm-file-remove')) return;
      fileInput.click();
    });
    fileInput.addEventListener('change', () => {
      _addFiles(fieldName, Array.from(fileInput.files), config);
      fileInput.value = '';
    });
    dz.addEventListener('dragenter', (e) => { e.preventDefault(); dz.classList.add('fmm-dragover'); });
    dz.addEventListener('dragover',  (e) => { e.preventDefault(); dz.classList.add('fmm-dragover'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('fmm-dragover'));
    dz.addEventListener('drop', (e) => {
      e.preventDefault();
      dz.classList.remove('fmm-dragover');
      _addFiles(fieldName, Array.from(e.dataTransfer.files), config);
    });
  }


  // ================================================================
  //  3. íŒŒì¼ ê´€ë¦¬
  // ================================================================

  function _addFiles(fieldName, newFiles, config) {
    _hideError(fieldName);
    const store = _state.files[fieldName];

    for (const file of newFiles) {
      if (store.length >= config.maxFiles) {
        _showError(fieldName, `ìµœëŒ€ ${config.maxFiles}ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        break;
      }
      if (file.size > config.maxSizeMB * 1024 * 1024) {
        _showError(fieldName, `"${file.name}" â€” ${config.maxSizeMB}MB ì´ˆê³¼`);
        continue;
      }
      if (store.some(f => f.file.name === file.name && f.file.size === file.size)) continue;

      const entry = { id: Date.now() + Math.random(), file, preview: null, base64: null, status: 'ready' };

      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° + base64 ìƒì„±
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          entry.preview = e.target.result;
          entry.base64 = e.target.result.split(',')[1];  // data:image/...;base64,XXX â†’ XXX
          _renderFileList(fieldName, config);
          // ìë™ ê²€ì¦ íŠ¸ë¦¬ê±°
          if (config.validate && _state.selectedCategory) {
            _validateImage(fieldName, entry);
          }
        };
        reader.readAsDataURL(file);
      }

      store.push(entry);
    }
    _renderFileList(fieldName, config);
  }

  function _removeFile(fieldName, fileId) {
    const config = FMM_CONFIG.UPLOAD_FIELDS[fieldName];
    _state.files[fieldName] = _state.files[fieldName].filter(f => f.id !== fileId);
    _renderFileList(fieldName, config);
    // ê²€ì¦ ê²°ê³¼ë„ ì´ˆê¸°í™”
    const vPanel = document.getElementById(`fmm-validation-${fieldName}`);
    if (vPanel) vPanel.innerHTML = '';
    delete _state.validationResults[fieldName];
    _updateDzState(fieldName, config);
  }
  // ì „ì—­ ì ‘ê·¼ìš©
  window._fmmRemoveFile = _removeFile;

  function _renderFileList(fieldName, config) {
    const listEl = document.getElementById(`fmm-list-${fieldName}`);
    const countEl = document.getElementById(`fmm-count-${fieldName}`);
    const store = _state.files[fieldName];

    if (listEl) {
      listEl.innerHTML = store.map(entry => {
        const thumb = entry.preview
          ? `<img class="fmm-file-thumb" src="${entry.preview}">`
          : `<div class="fmm-file-placeholder">${entry.file.type === 'application/pdf' ? 'ğŸ“„' : 'ğŸ–¼ï¸'}</div>`;
        const size = entry.file.size < 1024*1024
          ? (entry.file.size/1024).toFixed(1) + ' KB'
          : (entry.file.size/1024/1024).toFixed(1) + ' MB';
        return `
          <div class="fmm-file-item">
            ${thumb}
            <div class="fmm-file-info">
              <div class="fmm-file-name">${entry.file.name}</div>
              <div class="fmm-file-meta">${size}</div>
            </div>
            <button class="fmm-file-remove" onclick="event.stopPropagation();window._fmmRemoveFile('${fieldName}',${entry.id})" title="ì‚­ì œ">âœ•</button>
          </div>`;
      }).join('');
    }
    if (countEl) {
      countEl.textContent = store.length > 0 ? `${store.length} / ${config.maxFiles}ê°œ` : '';
    }
    _updateDzState(fieldName, config);
  }

  function _updateDzState(fieldName, config) {
    const dz = document.getElementById(`fmm-dz-${fieldName}`);
    const full = (_state.files[fieldName] || []).length >= config.maxFiles;
    if (dz) {
      dz.style.opacity = full ? '0.4' : '1';
      dz.style.pointerEvents = full ? 'none' : 'auto';
    }
  }


  // ================================================================
  //  4. Claude Vision ê²€ì¦ í˜¸ì¶œ
  // ================================================================

  async function _validateImage(fieldName, entry) {
    if (!entry.base64 || !_state.selectedCategory) return;

    const vPanel = document.getElementById(`fmm-validation-${fieldName}`);
    if (!vPanel) return;

    // â”€â”€ ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ â”€â”€
    vPanel.innerHTML = `
      <div class="fmm-validating">
        <div class="fmm-spinner"></div>
        <div class="fmm-validating-text">
          AIê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>
          <span style="font-weight:400;font-size:12px;color:var(--fmm-gray-500)">
            ì„ íƒí•˜ì‹  "${FMM_CONFIG.CATEGORIES[_state.selectedCategory]?.label_ko || ''}" ì¹´í…Œê³ ë¦¬ì™€ì˜ ê´€ë ¨ì„±ì„ ê²€ì¦ ì¤‘
          </span>
        </div>
      </div>
    `;

    try {
      // â”€â”€ API í˜¸ì¶œ â”€â”€
      const response = await fetch(FMM_CONFIG.API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          image_base64: entry.base64,
          image_type: entry.file.type || 'image/jpeg',
          category: _state.selectedCategory,
          contact_email: _getFormValue('email'),
        }),
      });

      if (!response.ok) throw new Error(`Server error: ${response.status}`);

      const result = await response.json();
      _state.validationResults[fieldName] = result;

      // â”€â”€ ê²°ê³¼ í‘œì‹œ â”€â”€
      _renderValidationResult(fieldName, result);

    } catch (err) {
      console.error('[FMM] Validation error:', err);
      vPanel.innerHTML = `
        <div class="fmm-validating" style="border-color:#fde68a;background:var(--fmm-amber-light)">
          <div style="font-size:20px">âš ï¸</div>
          <div class="fmm-validating-text" style="color:var(--fmm-amber)">
            ì´ë¯¸ì§€ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
            <span style="font-weight:400;font-size:12px;color:var(--fmm-gray-500)">
              í¼ì€ ì •ìƒì ìœ¼ë¡œ ì œì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ìˆ˜ë™ ê²€í† ê°€ ì§„í–‰ë©ë‹ˆë‹¤.
            </span>
          </div>
        </div>
      `;
      _state.validationResults[fieldName] = { recommendation: 'review', relevance_score: 0, reasoning: 'API ì˜¤ë¥˜ â€” ìˆ˜ë™ ê²€í†  í•„ìš”' };
    }
  }

  function _renderValidationResult(fieldName, result) {
    const vPanel = document.getElementById(`fmm-validation-${fieldName}`);
    if (!vPanel) return;

    const score = (result.relevance_score || 0);
    const rec = result.recommendation || 'review';
    const circumference = 2 * Math.PI * 19;  // radius 19
    const offset = circumference * (1 - score);

    let statusClass, statusIcon, statusText, strokeColor;
    if (rec === 'approve') {
      statusClass = 'fmm-vp-approve'; statusIcon = 'âœ…'; statusText = 'ê²€ì¦ í†µê³¼';
      strokeColor = 'var(--fmm-green)';
    } else if (rec === 'review') {
      statusClass = 'fmm-vp-review'; statusIcon = 'âš ï¸'; statusText = 'ìˆ˜ë™ ê²€í†  í•„ìš”';
      strokeColor = 'var(--fmm-amber)';
    } else {
      statusClass = 'fmm-vp-reject'; statusIcon = 'âŒ'; statusText = 'ê²€ì¦ ë¯¸í†µê³¼';
      strokeColor = 'var(--fmm-red)';
    }

    const redFlagsHtml = (result.red_flags && result.red_flags.length > 0)
      ? `<dt>ğŸš© ì˜ì‹¬ ìš”ì†Œ</dt><dd>${result.red_flags.join(', ')}</dd>`
      : '';

    vPanel.innerHTML = `
      <div class="fmm-validation-panel ${statusClass}">
        <div class="fmm-vp-header">
          <div class="fmm-score-ring">
            <svg viewBox="0 0 44 44">
              <circle class="ring-bg" cx="22" cy="22" r="19"/>
              <circle class="ring-fg" cx="22" cy="22" r="19"
                style="stroke:${strokeColor};stroke-dasharray:${circumference};stroke-dashoffset:${offset}"/>
            </svg>
            <div class="fmm-score-value" style="color:${strokeColor}">${Math.round(score * 100)}</div>
          </div>
          <div>
            <div>${statusIcon} ${statusText}</div>
            <div style="font-size:11px;font-weight:400;color:var(--fmm-gray-500);margin-top:2px">
              ê´€ë ¨ì„± ì ìˆ˜: ${score.toFixed(2)} / 1.00
            </div>
          </div>
        </div>
        <div class="fmm-vp-body">
          <dl>
            ${result.product_or_procedure ? `<dt>ì‹ë³„ëœ ì œí’ˆ/ì‹œìˆ </dt><dd>${result.product_or_procedure}</dd>` : ''}
            ${result.brand_or_clinic ? `<dt>ë¸Œëœë“œ/ê¸°ê´€</dt><dd>${result.brand_or_clinic}</dd>` : ''}
            ${result.date_detected ? `<dt>ë‚ ì§œ</dt><dd>${result.date_detected}</dd>` : ''}
            ${result.amount_detected ? `<dt>ê¸ˆì•¡</dt><dd>${result.amount_detected}</dd>` : ''}
            <dt>AI íŒë‹¨ ê·¼ê±°</dt><dd>${result.reasoning || 'â€”'}</dd>
            ${redFlagsHtml}
          </dl>
        </div>
      </div>
    `;

    // â”€â”€ ìµœì¢… ê²°ê³¼ ë°°ë„ˆ (ì œí’ˆ+ì˜ìˆ˜ì¦ ëª¨ë‘ ê²€ì¦ ì™„ë£Œ ì‹œ) â”€â”€
    _checkOverallResult();
  }


  // ================================================================
  //  5. ì¢…í•© ê²°ê³¼ íŒë‹¨
  // ================================================================

  function _checkOverallResult() {
    const bannerContainer = document.getElementById('fmm-overall-result');
    if (bannerContainer) bannerContainer.remove();

    // ëª¨ë“  validate:true í•„ë“œê°€ ê²°ê³¼ë¥¼ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
    const validateFields = Object.entries(FMM_CONFIG.UPLOAD_FIELDS)
      .filter(([_, c]) => c.validate)
      .map(([name]) => name);

    const allDone = validateFields.every(f => _state.validationResults[f]);
    if (!allDone) return;

    // ìµœì¢… íŒì •
    const results = validateFields.map(f => _state.validationResults[f]);
    const avgScore = results.reduce((s, r) => s + (r.relevance_score || 0), 0) / results.length;
    const hasReject = results.some(r => r.recommendation === 'reject');
    const hasReview = results.some(r => r.recommendation === 'review');

    let overallRec;
    if (hasReject) overallRec = 'reject';
    else if (hasReview) overallRec = 'review';
    else overallRec = 'approve';

    // ë°°ë„ˆ ì‚½ì…
    const banner = document.createElement('div');
    banner.id = 'fmm-overall-result';

    if (overallRec === 'approve') {
      banner.innerHTML = `
        <div class="fmm-next-step">
          <h3>ğŸ‰ ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
          <p>ì´ë¯¸ì§€ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ì œì¶œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¸í„°ë·° ì¼ì •ì„ ì¡ì•„ì£¼ì„¸ìš”.</p>
        </div>
      `;
    } else if (overallRec === 'reject') {
      banner.innerHTML = `
        <div class="fmm-rejected-banner">
          <h3>ì£„ì†¡í•©ë‹ˆë‹¤. ì¸í„°ë·° ì¡°ê±´ì— ë¶€í•©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</h3>
          <p>ì—…ë¡œë“œí•˜ì‹  ì´ë¯¸ì§€ê°€ ì„ íƒí•˜ì‹  ì¹´í…Œê³ ë¦¬ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
          ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì‹œê±°ë‚˜, ì˜¬ë°”ë¥¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        </div>
      `;
    } else {
      banner.innerHTML = `
        <div class="fmm-validating" style="border-color:#fde68a;background:var(--fmm-amber-light)">
          <div style="font-size:20px">ğŸ“‹</div>
          <div style="font-size:13px;color:var(--fmm-amber)">
            <strong>ì¶”ê°€ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤</strong><br>
            <span style="font-weight:400;font-size:12px;color:var(--fmm-gray-500)">
              ì œì¶œì€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹´ë‹¹ìê°€ í™•ì¸ í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
            </span>
          </div>
        </div>
      `;
    }

    // ì œì¶œ ë²„íŠ¼ ì•ì— ì‚½ì…
    const submitDiv = _state.formEl.querySelector('.hs-submit, .hs_submit');
    if (submitDiv) {
      submitDiv.parentElement.insertBefore(banner, submitDiv);
    }

    // reject ì‹œ ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
    const submitBtn = _state.formEl.querySelector('input[type="submit"], button[type="submit"]');
    if (submitBtn && overallRec === 'reject') {
      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.4';
      submitBtn.style.cursor = 'not-allowed';
    } else if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.style.opacity = '1';
      submitBtn.style.cursor = 'pointer';
    }
  }


  // ================================================================
  //  6. í¼ ì œì¶œ ì¸í„°ì…‰íŠ¸
  // ================================================================

  function interceptFormSubmit(form) {
    form.addEventListener('submit', function(e) {
      // ì¹´í…Œê³ ë¦¬ ë¯¸ì„ íƒ ì²´í¬
      if (!_state.selectedCategory) {
        e.preventDefault();
        alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      // í•„ìˆ˜ íŒŒì¼ ì—…ë¡œë“œ ì²´í¬
      for (const [fieldName, config] of Object.entries(FMM_CONFIG.UPLOAD_FIELDS)) {
        if (config.validate && _state.files[fieldName].length === 0) {
          e.preventDefault();
          _showError(fieldName, `${config.label}ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.`);
          return;
        }
      }

      // reject ìƒíƒœë©´ ì œì¶œ ì°¨ë‹¨
      const overallBanner = document.getElementById('fmm-overall-result');
      if (overallBanner && overallBanner.querySelector('.fmm-rejected-banner')) {
        e.preventDefault();
        return;
      }

      // ê²€ì¦ ê²°ê³¼ë¥¼ hidden fieldì— ì €ì¥
      _setHiddenFieldValue('screening_status',
        _getOverallRecommendation());
      _setHiddenFieldValue('screening_score',
        String(_getAverageScore()));
    });
  }


  // ================================================================
  //  ìœ í‹¸ë¦¬í‹°
  // ================================================================

  function _getFormValue(fieldName) {
    if (!_state.formEl) return '';
    const input = _state.formEl.querySelector(`input[name="${fieldName}"]`);
    return input ? input.value : '';
  }

  function _setHiddenFieldValue(fieldName, value) {
    if (!_state.formEl) return;
    let input = _state.formEl.querySelector(`input[name="${fieldName}"]`);
    if (!input) {
      // hidden input ìƒì„±
      input = document.createElement('input');
      input.type = 'hidden';
      input.name = fieldName;
      _state.formEl.appendChild(input);
    }
    input.value = value;
  }

  function _getOverallRecommendation() {
    const results = Object.values(_state.validationResults);
    if (results.length === 0) return 'review';
    if (results.some(r => r.recommendation === 'reject')) return 'reject';
    if (results.some(r => r.recommendation === 'review')) return 'review';
    return 'approve';
  }

  function _getAverageScore() {
    const results = Object.values(_state.validationResults);
    if (results.length === 0) return 0;
    return results.reduce((s, r) => s + (r.relevance_score || 0), 0) / results.length;
  }

  function _showError(fieldName, msg) {
    const el = document.getElementById(`fmm-err-${fieldName}`);
    if (el) { el.textContent = msg; el.classList.add('show'); }
  }

  function _hideError(fieldName) {
    const el = document.getElementById(`fmm-err-${fieldName}`);
    if (el) el.classList.remove('show');
  }

  function _clearAllValidations() {
    Object.keys(FMM_CONFIG.UPLOAD_FIELDS).forEach(fieldName => {
      const vPanel = document.getElementById(`fmm-validation-${fieldName}`);
      if (vPanel) vPanel.innerHTML = '';
      delete _state.validationResults[fieldName];
    });
    const overall = document.getElementById('fmm-overall-result');
    if (overall) overall.remove();

    // ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ ì¬ê²€ì¦ íŠ¸ë¦¬ê±°
    Object.entries(FMM_CONFIG.UPLOAD_FIELDS).forEach(([fieldName, config]) => {
      if (config.validate && _state.files[fieldName].length > 0 && _state.selectedCategory) {
        const firstFile = _state.files[fieldName][0];
        if (firstFile.base64) {
          _validateImage(fieldName, firstFile);
        }
      }
    });
  }

})();
</script>
